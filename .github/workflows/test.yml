name: Test PDF Processing

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_processing:
        description: 'Force processing even if URLs haven not changed'
        required: false
        default: 'false'
        type: boolean

jobs:
  test-processing:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push commits
      actions: read   # Required to read workflow files
    outputs:
      data_updated: ${{ steps.process.outputs.data_updated }}
      shops_count: ${{ steps.process.outputs.shops_count }}
      pdfs_processed: ${{ steps.process.outputs.pdfs_processed }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create data directory
      run: mkdir -p data
        
    - name: Debug Test (No API Usage)
      run: |
        cd scripts
        echo "🧪 Running debug tests first..."
        python debug_test.py || echo "Debug test completed with issues"
        
    - name: Test PDF Processing with Real API Key
      id: process
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        FORCE_PROCESSING: ${{ github.event.inputs.force_processing || 'true' }}
      run: |
        # Debug secret access first
        echo "🔍 Debugging secret access:"
        if [ -z "$GEMINI_API_KEY" ]; then
          echo "❌ GEMINI_API_KEY is not accessible in this workflow"
          echo "Please check repository secrets configuration"
          exit 1
        else
          echo "✅ GEMINI_API_KEY is accessible (${#GEMINI_API_KEY} chars)"
        fi
        
        if [ -z "$GOOGLE_MAPS_API_KEY" ]; then
          echo "❌ GOOGLE_MAPS_API_KEY is not accessible in this workflow"
          echo "Please check repository secrets configuration"
        else
          echo "✅ GOOGLE_MAPS_API_KEY is accessible (${#GOOGLE_MAPS_API_KEY} chars)"
        fi
        
        cd scripts
        echo "🧪 Testing PDF processing with real API key..."
        
        # Show environment info
        echo "Python version: $(python --version)"
        echo "Working directory: $(pwd)"
        echo "Files in directory: $(ls -la)"
        
        # Force processing for testing
        echo "🔄 Force processing enabled for testing"
        python process_pdfs.py --force
        
    - name: Check if data files changed
      id: check_changes
      run: |
        # Check if latest.json was created (indicates processing happened)
        # This approach avoids problematic git status --cached commands
        if [ -f "data/latest.json" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "📊 Data files updated, committing changes"
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # Add data files
          git add data/
          
          # Debug info
          echo "📁 Files in data directory:"
          ls -la data/
          
          # Get shop count for commit message
          SHOPS_COUNT=$(cat data/latest.json | python -c "import sys, json; print(json.load(sys.stdin)['totalShops'])" 2>/dev/null || echo "unknown")
          
          # Commit and push the changes
          git commit -m "🤖 Update shop data - $(date -u +"%Y-%m-%d %H:%M UTC")

          📊 Shop count: ${SHOPS_COUNT}
          🤖 Model: gemini-2.5-flash
          🗺️  Coordinates: Google Maps geocoding
          🔍 Auto-discovered PDFs from happy-kaimonoken.info"
          
          echo "📤 Pushing changes to repository..."
          git push
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "📊 No processing needed - PDF URLs haven't changed"
        fi
        
    - name: Show results
      run: |
        echo "🎉 Test completed!"
        echo "📊 Data updated: ${{ steps.check_changes.outputs.changed }}"
        if [[ "${{ steps.process.outputs.shops_count }}" != "" ]]; then
          echo "🏪 Shops processed: ${{ steps.process.outputs.shops_count }}"
        fi
        if [[ "${{ steps.process.outputs.pdfs_processed }}" != "" ]]; then
          echo "📄 PDFs processed: ${{ steps.process.outputs.pdfs_processed }}"
        fi
        
        # Show sample of generated data
        if [ -f "data/latest.json" ]; then
          echo "📄 Sample of generated data:"
          head -50 data/latest.json
        fi
        
    - name: Upload test results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: data/
        retention-days: 7